---
title: '`r params$title `'
author: '`r params$authors `'
output: 
  rmarkdown::pdf_document: 
    #rmdformats::robobook:
    toc: true
    toc_depth: 4
    number_sections: true
    linkcolor: 'blue'
    # css: styles.css
    # highlight: tango
    # use_bookdown: true
    #template: mytemplate.tex
  word_document:
    rmdformats::robobook:
    toc: yes
    css: styles.css
    highlight: tango
    use_bookdown: true
  BiocStyle::html_document:
    rmdformats::robobook:
    number_sections: yes
    toc: yes
    toc_depth: 4
    css: styles.css
    highlight: tango
    use_bookdown: true
always_allow_html: true
params: 
  otherDataList: NA
  filterCountLevel: NA
  filterCountN: NA
  filterCountGroup : NA
  doFilterCount: NA
  doProductive: NA 
  dropSampleNames: NA 
  publicLevel: NA
  publicGroup: NA 
  doPublic: NA 
  privateLevel: NA 
  privateSingletons: NA 
  doPrivate: NA 
  topSeqLevel: NA
  topSeqGroup: NA
  topSeqProp: NA
  doTopSeq: NA 
  downSampleSize: NA
  downseed: NA
  downReplace: NA
  doDown: NA
  DownLevel: NA
  doNorm: NA
  NormLevel: NA
  plotStats: NA
  countLevel: NA
  countScale: NA
  plotRare: NA
  divIndex: NA
  divLevel: NA
  renyiLevel: NA
  countIntLevel: NA
  rankDistribLevel: NA
  rankDistribGroupMeth: NA
  singleSample: NA
  indLevel: NA
  indgeneUsageLevel: NA
  singleScale: NA
  VJLevel: NA
  VJProp: NA
  singleProp: NA
  spectraProp: NA
  statisticsStat: NA
  statisticsGroup: NA
  diverLevel: NA
  diverGroup: NA
  diverIndex: NA
  multrenLevel: NA
  multrenGroup: NA
  countIntervalsLevel: NA
  countIntervalsGroup: NA
  multRankLevel: NA
  multRankScale: NA
  multRankGroup: NA
  geneUsageLevel: NA
  geneUsageScale: NA
  geneUsageGroup: NA
  vennLevel: NA
  vennSamples: NA
  scatterUISample: NA
  scatterLevel: NA
  scatterScale: NA
  dissimilarityLevel: NA
  dissimilarityIndex: NA
  dissimilarityClustering: NA
  doHm1: NA
  MDSLevel: NA
  MDSMethod: NA
  grpCol4MDS: NA
  diffGroup: NA
  doHm: NA 
  diffFC: NA
  diffPV: NA
  diffLevel: NA
  diffPCALevel: NA
  PCAMethod: NA
  diffPCAGroup: NA
  PertGroupSelected: NA
  CtrlGroup: NA
  pertDist: NA
  pertPower: NA
  pertOrder: NA
  dataFiltered: null
  repseqdt: null
  downText: null
  shannonText: null
  metadatastatsText: null
  countfeaturesText: null
  rarefactionText: null
  divindText: null
  renyiindText: null
  countindexpText: null
  rankdistribexpText: null
  IndCountIntText: null
  VJUsageText: null
  VJGeneUsageText: null
  cd3spectraText: null
  cd3spectraindText: null
  statsText: null
  divText: null
  renyiText: null
  countIntText: null
  rankDistribText: null
  geneUsageText: null
  eulerrText: null
  scatterText: null
  disHMText: null
  MDSText: null
  volcanoText: null
  PCAText: null
  spectratypingcomparisonHMText: null
  authors: null
  title: "Report"
  doStats: null
  dogeneUsage: null
  doCountInt: null
  doDiversity: null
---


<style type="text/css">
<!-- div#TOC li { -->
<!--     list-style:none; -->
<!--     background-image:none; -->
<!--     background-repeat:none; -->
<!--     background-position:0;  -->
<!-- } -->
 .book .book-body .page-inner  { 
    max-width: 1400px; 
 <!-- width: 120%;  -->
 } 
 .column-left {
  float: left;
  width: 49.7%;
}
.column-right{
 float: right;
  width: 49.7%;
}
.col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
h1 {
  color: #033c73;
   font-size: 30px;
}
h1.title {
  color: #033c73;
}
h2 {
  color: #033c73;
  font-size: 24px;
}
h3 {
   color: #033c73;
   font-size: 18px;
}
h4 {
   color: #022f5a;
}
h5 {
  color: #033c73;
}
h6 {
   color: #033c73;
}
body{ 
  font-size: 14px;
}
p.caption {
  font-size: 0.9em;
  font-style: italic;
  color: grey;
  margin-right: 10%;
  margin-left: 10%;  
  text-align: justify;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r show data manipulation title, results='asis', echo=FALSE}
if((!is.null(params$filterCountLevel) && !is.null(params$filterCountN) && !is.null(params$filterCountGroup) && params$doFilterCount == 1) ||
   (params$doProductive == 1) ||
   (!is.null(params$dropSampleNames)) || 
   (!is.null(params$publicLevel) && !is.null(params$publicGroup) && params$doPublic == 1) || 
   (!is.null(params$privateLevel) && !is.null(params$privateSingletons) && params$doPrivate == 1) || 
   (!is.null(params$topSeqLevel) && !is.null(params$topSeqGroup) && !is.null(params$topSeqProp) && params$doTopSeq == 1) || 
   (!is.null(params$downSampleSize) && !is.null(params$downseed) && !is.null(params$downReplace) && params$doDown == TRUE) ||
   (params$doNorm == TRUE)){cat("# Data manipulation")}
```


```{r show filtering title, results='asis', echo=FALSE}
if((!is.null(params$filterCountLevel) && !is.null(params$filterCountN) && !is.null(params$filterCountGroup) && params$doFilterCount == 1) ||
   (params$doProductive == 1) ||
   (!is.null(params$dropSampleNames)) || 
   (!is.null(params$publicLevel) && !is.null(params$publicGroup) && params$doPublic == 1) || 
   (!is.null(params$privateLevel) && !is.null(params$privateSingletons) && params$doPrivate == 1) || 
   (!is.null(params$topSeqLevel) && !is.null(params$topSeqGroup) && !is.null(params$topSeqProp) && params$doTopSeq == 1)){cat("## Filtering")}
```


```{r show filter count title, results='asis', echo=FALSE}
if(!is.null(params$filterCountLevel) && !is.null(params$filterCountN) && !is.null(params$filterCountGroup) && params$doFilterCount == 1){cat("**Filter out a repertoire level count**")}
```

```{r repcount, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE}
if(!is.null(params$filterCountLevel) && !is.null(params$filterCountN) && !is.null(params$filterCountGroup) && params$doFilterCount == 1){
   filterCount(x = params$repseqdt, level = params$filterCountLevel, n = params$filterCountN, group = params$filterCountGroup)
   historydata <- AnalyzAIRR::History(params$dataFiltered)
   flextable::flextable(head(historydata)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")   
}
      
```


```{r show filter prod title, results='asis', echo=FALSE}
if(params$doProductive == 1){cat("**Filter out unproductive sequences**")}
```

```{r productive, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(params$doProductive == 1){
   getProductive(x = params$repseqdt)
   historydata <- AnalyzAIRR::History(params$dataFiltered)
   flextable::flextable(head(historydata)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")
}
      
```


```{r show drop samples title, results='asis', echo=FALSE}
if(!is.null(params$dropSampleNames)){cat("**Drop a sample**")}
```

```{r dropsample,  echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(!is.null(params$dropSampleNames)){
   dropSamples(x = params$repseqdt, sampleNames = params$dropSampleNames)
   historydata <- AnalyzAIRR::History(params$dataFiltered)
   flextable::flextable(head(historydata)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")
}
      
```


```{r show public title, results='asis', echo=FALSE}
if(!is.null(params$publicLevel) && !is.null(params$publicGroup) && params$doPublic == 1){cat("**Extract shared sequences**")}
```

```{r public, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(!is.null(params$publicLevel) && !is.null(params$publicGroup) && params$doPublic == 1){
   getPublic(x = params$repseqdt, level = params$publicLevel, group = params$publicGroup)
   historydata <- AnalyzAIRR::History(params$dataFiltered)
   flextable::flextable(head(historydata)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")
}
      
```


```{r show private title, results='asis', echo=FALSE}
if(!is.null(params$privateLevel) && !is.null(params$privateSingletons) && params$doPrivate == 1){cat("**Extract private sequences**")}
```

```{r private, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(!is.null(params$privateLevel) && !is.null(params$privateSingletons) && params$doPrivate == 1){
   getPrivate(x = params$repseqdt, level = params$privateLevel, singletons = params$privateSingletons)
   historydata <- AnalyzAIRR::History(params$dataFiltered)
   flextable::flextable(head(historydata)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")
}
      
```


```{r show topseq title, results='asis', echo=FALSE}
if(!is.null(params$topSeqLevel) && !is.null(params$topSeqGroup) && !is.null(params$topSeqProp) && params$doTopSeq == 1){cat("**Extract top sequences**")}
```

```{r topseq, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(!is.null(params$topSeqLevel) && !is.null(params$topSeqGroup) && !is.null(params$topSeqProp) && params$doTopSeq == 1){
   getTopSequences(x=params$repseqdt, level = params$topSeqLevel, group = params$topSeqGroup, prop = params$topSeqProp)
   historydata <- AnalyzAIRR::History(params$dataFiltered)
   flextable::flextable(head(historydata)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")
}
      
```


```{r show normalization title, results='asis', echo=FALSE}
if((!is.null(params$downSampleSize) && !is.null(params$downseed) && !is.null(params$downReplace) && params$doDown == TRUE) ||
   (params$doNorm == TRUE)){cat("## Normalization")}
```


```{r show downsampling title, results='asis', echo=FALSE}
if(!is.null(params$downSampleSize) && !is.null(params$downseed) && !is.null(params$downReplace) && params$doDown == TRUE){cat("**Down-sampling**")}
```

```{r down-sampling, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(!is.null(params$downSampleSize) && !is.null(params$downseed) && !is.null(params$downReplace) && params$doDown == TRUE){
   sampleRepSeqExp(x = params$repseqdt, sample.size = params$downSampleSize, rngseed = isolate(params$downseed), replace = params$downReplace, verbose = FALSE)
   historydata <- AnalyzAIRR::History(params$dataFiltered)
   flextable::flextable(head(historydata)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")
}
      
```


```{r show down-sampling, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$DownLevel) && params$doDown == TRUE){
   cts1 <- AnalyzAIRR::assay(params$repseqdt)
        p1 <- histSums(cts1[, sum(count), by=eval(params$DownLevel)][,V1], xlab="count", ylab=paste0("Number of ", params$DownLevel)) +
            ggtitle("Orignial data")+
            theme_RepSeq()+
            theme(axis.title.x = ggplot2::element_text(size=15),
                  axis.title.y = ggplot2::element_text(size=15),
                  axis.text.x = ggplot2::element_text(size=15),
                  axis.text.y = ggplot2::element_text(size=15))
        cts2 <- AnalyzAIRR::assay(downSampling())
        p2 <- histSums(cts2[, sum(count), by=eval(params$DownLevel)][,V1], xlab="count", ylab=paste0("Number of ", params$DownLevel)) +
            ggtitle("Downsampled data") +
            theme_RepSeq()+
            theme(axis.title.x = ggplot2::element_text(size=15),
                  axis.title.y = ggplot2::element_text(size=15),
                  axis.text.x = ggplot2::element_text(size=15),
                  axis.text.y = ggplot2::element_text(size=15))

        gridExtra::grid.arrange(p1, p2, ncol=2)
}
      
```

```{r show down-sampling text entry, echo = FALSE, results='asis'}
if(!is.null(params$downSampleSize) && !is.null(params$downseed) && !is.null(params$downReplace) && params$doDown == TRUE){
  cat(params$downText)
}
```


```{r show shannon title, results='asis', echo=FALSE}
if(params$doNorm == TRUE){cat("**Shannnon-based normalization**")}
```

```{r shannon, echo=FALSE, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(params$doNorm == TRUE){
   ShannonNorm(x = params$repseqdt)
   historydata <- AnalyzAIRR::History(params$dataFiltered)
   flextable::flextable(head(historydata)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")
}
      
```

```{r show shannon, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$NormLevel) && params$doNorm == TRUE){
   cts1 <- AnalyzAIRR::assay(params$repseqdt)
        p1 <- histSums(cts1[, sum(count), by=eval(params$NormLevel)][,V1], xlab="count", ylab=paste0("Number of ", params$NormLevel)) +
            ggtitle("Orignial data")+
            theme_RepSeq()+
            theme(axis.title.x = ggplot2::element_text(size=15),
                  axis.title.y = ggplot2::element_text(size=15),
                  axis.text.x = ggplot2::element_text(size=15),
                  axis.text.y = ggplot2::element_text(size=15))
        cts2 <- AnalyzAIRR::assay(shannonNormed())
        p2 <- histSums(cts2[, sum(count), by=eval(params$NormLevel)][,V1], xlab="count", ylab=paste0("Number of ", params$NormLevel)) +
            ggtitle("Shannon normalized data") +
            theme_RepSeq()+
            theme(axis.title.x = ggplot2::element_text(size=15),
                  axis.title.y = ggplot2::element_text(size=15),
                  axis.text.x = ggplot2::element_text(size=15),
                  axis.text.y = ggplot2::element_text(size=15))
        
        gridExtra::grid.arrange(p1, p2, ncol=2)
}
      
```

```{r show shannon text entry, echo = FALSE, results='asis'}
if(!is.null(params$NormLevel) && params$doNorm == TRUE){
  cat(params$shannonText)
}
```


```{r show Exploratory statistics title, results='asis', echo=FALSE}
if((!is.null(params$plotStats)) || 
   (params$countLevel != "" && !is.null(params$countScale)) || 
   (!is.null(params$plotRare)) ||
   (!is.null(params$divIndex) && params$divLevel != "") || 
   (params$renyiLevel != "") || 
   (params$countIntLevel != "") || 
   (params$rankDistribLevel != "" && params$rankDistribGroupMeth != "")){cat("# Exploratory statistics")}
```


```{r show Basic statistics title, results='asis', echo=FALSE}
if((!is.null(params$plotStats)) || 
   (params$countLevel != "" && !is.null(params$countScale))){cat("## Basic statistics")}
```


```{r show metadata statistics title, results='asis', echo=FALSE}
if(!is.null(params$plotStats)){cat("### Metadata statistics")}
```

```{r metadata stats, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$plotStats)){
   plotStatistics(x=params$dataFiltered, stat = params$plotStats, groupBy = NULL, label_colors = NULL)
}
      
```

```{r show metadata stats text entry, echo = FALSE, results='asis'}
if(!is.null(params$plotStats)){
  cat(params$metadatastatsText)
}
```


```{r show Detailed repertoire level statistics title, results='asis', echo=FALSE}
if(params$countLevel != "" && !is.null(params$countScale)){cat("### Detailed repertoire level statistics")}
```

```{r countfeatures, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(params$countLevel != "" && !is.null(params$countScale)){
   countfeatures <- countFeatures(x=params$dataFiltered, level = params$countLevel, scale = params$countScale, group = NULL)
   flextable::flextable(head(countfeatures)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")   
}
      
```

```{r show count features text entry, echo = FALSE, results='asis'}
if(params$countLevel != "" && !is.null(params$countScale)){
  cat(params$countfeaturesText)
}
```


```{r show Diversity estimation title, results='asis', echo=FALSE}
if((!is.null(params$plotRare)) ||
   (!is.null(params$divIndex) && params$divLevel != "") || 
   (params$renyiLevel != "")){cat("## Diversity estimation ")}
```

```{r show Rarefaction analysis title, results='asis', echo=FALSE}
if(!is.null(params$plotRare)){cat("### Rarefaction analysis")}
```

```{r rarefaction, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$plotRare)){
   plotRarefaction(x=params$dataFiltered, colorBy = params$plotRare, label_colors = NULL)+ggplot2::theme(legend.position = "right")
}
      
```

```{r show rarefaction text entry, echo = FALSE, results='asis'}
if(!is.null(params$plotRare)){
  cat(params$rarefactionText)
}
```


```{r rarefactiontab, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(!is.null(params$plotRare)){
   raretab <- rarefactionTab(x = params$dataFiltered)
   flextable::flextable(head(raretab)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")  
}
      
```


```{r show Diversity indices title, results='asis', echo=FALSE}
if(!is.null(params$divIndex) && params$divLevel != ""){cat("### Diversity indices")}
```

```{r div ind, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$divIndex) && params$divLevel != ""){
   plotDiversity(x=params$dataFiltered, index = params$divIndex, level = params$divLevel, groupBy = NULL, label_colors = NULL)
}
      
```

```{r show div ind entry, echo = FALSE, results='asis'}
if(!is.null(params$divIndex) && params$divLevel != ""){
  cat(params$divindText)
}
```


```{r divindtab, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(params$divLevel != ""){
   divind <- diversityIndices(x=params$dataFiltered, level = params$divLevel)
   flextable::flextable(head(divind)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header") 
}
      
```


```{r show Renyi index title, results='asis', echo=FALSE}
if(params$renyiLevel != ""){cat("### Renyi index")}
```

```{r renyi ind, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(params$renyiLevel != ""){
   plotRenyiIndex(x=params$dataFiltered, level = params$renyiLevel, colorBy = "sample_id", grouped = FALSE, label_colors = NULL)
}
      
```

```{r show renyi ind entry, echo = FALSE, results='asis'}
if(params$renyiLevel != ""){
  cat(params$renyiindText)
}
```


```{r renyiindtab, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(params$renyiLevel != ""){
   renind <- renyiIndex(x=params$dataFiltered, level = params$renyiLevel)
   flextable::flextable(head(renind)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header") 
}
      
```


```{r show Clonal distribution title, results='asis', echo=FALSE}
if((params$countIntLevel != "") || 
   (params$rankDistribLevel != "" && params$rankDistribGroupMeth != "")){cat("## Clonal distribution")}
```


```{r show Per count interval title, results='asis', echo=FALSE}
if(params$countIntLevel != ""){cat("### Per count interval")}
```

```{r count ind exp, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(params$countIntLevel != ""){
    plotCountIntervals(x=params$dataFiltered, level = params$countIntLevel, groupBy = NULL, label_colors = NULL)
}
      
```

```{r show count ind exp entry, echo = FALSE, results='asis'}
if(params$countIntLevel != ""){
  cat(params$countindexpText)
}
```


```{r show Per decreasing rank title, results='asis', echo=FALSE}
if(params$rankDistribLevel != "" && params$rankDistribGroupMeth != ""){cat("### Per decreasing rank")}
```

```{r rank distrib exp, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(params$rankDistribLevel != "" && params$rankDistribGroupMeth != ""){
    plotRankDistrib(x = params$dataFiltered, level = params$rankDistribLevel, scale = params$rankDistribGroupMeth, colorBy = "sample_id", grouped = FALSE, label_colors = NULL)
}
      
```

```{r show rank distrib exp text entry, echo = FALSE, results='asis'}
if(params$rankDistribLevel != "" && params$rankDistribGroupMeth != ""){
  cat(params$rankdistribexpText)
}
```


```{r show One-sample analysis title, results='asis', echo=FALSE}
if((!is.null(params$singleSample) && params$indLevel != "") || 
   (!is.null(params$singleSample) && params$indgeneUsageLevel != "" && !is.null(params$singleScale)) || 
   (!is.null(params$singleSample) && params$VJLevel != "" && !is.null(params$singleScale) && !is.null(params$VJProp)) || 
   (!is.null(params$singleSample) && !is.null(params$singleScale) && !is.null(params$singleProp)) || 
   (!is.null(params$singleSample) && !is.null(params$singleScale) && !is.null(params$spectraProp))){cat("# One-sample analysis")}
```


```{r show Clonal distribution per count intervals title, results='asis', echo=FALSE}
if(!is.null(params$singleSample) && params$indLevel != ""){cat("### Clonal distribution per count intervals")}
```

```{r IndCountInt, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$singleSample) && params$indLevel != ""){
   plotIndCountIntervals(x = params$dataFiltered, sampleName = params$singleSample, level = params$indLevel)
}
      
```

```{r show IndCountInt text entry, echo = FALSE, results='asis'}
if(!is.null(params$singleSample) && params$indLevel != ""){
  cat(params$IndCountIntText)
}
```


```{r show V/J usage title, results='asis', echo=FALSE}
if(!is.null(params$singleSample) && params$indgeneUsageLevel != "" && !is.null(params$singleScale)){cat("### V/J usage")}
```

```{r VJUsage, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$singleSample) && params$indgeneUsageLevel != "" && !is.null(params$singleScale)){
   plotIndGeneUsage(x = params$dataFiltered, sampleName = params$singleSample, level = params$indgeneUsageLevel, scale = params$singleScale)
}
      
```

```{r show VJUsage text entry, echo = FALSE, results='asis'}
if(!is.null(params$singleSample) && params$indgeneUsageLevel != "" && !is.null(params$singleScale)){
  cat(params$VJUsageText)
}
```


```{r show V-J combination usage title, results='asis', echo=FALSE}
if(!is.null(params$singleSample) && params$VJLevel != "" && !is.null(params$singleScale) && !is.null(params$VJProp)){cat("### V-J combination usage")}
```

```{r VJGeneUsage, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$singleSample) && params$VJLevel != "" && !is.null(params$singleScale) && !is.null(params$VJProp)){
   plotVJusage(x = params$dataFiltered, sampleName = params$singleSample, scale = params$singleScale, level = params$VJLevel, prop = params$VJProp) 
}
      
```

```{r show VJGeneUsage text entry, echo = FALSE, results='asis'}
if(!is.null(params$singleSample) && params$VJLevel != "" && !is.null(params$singleScale) && !is.null(params$VJProp)){
  cat(params$VJGeneUsageText)
}
```


```{r show Stacked spectratyping title, results='asis', echo=FALSE}
if(!is.null(params$singleSample) && !is.null(params$singleScale) && !is.null(params$singleProp)){cat("### Stacked spectratyping")}
```

```{r cd3 spectra, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$singleSample) && !is.null(params$singleScale) && !is.null(params$singleProp)){
   plotSpectratyping(x = params$dataFiltered, sampleName = params$singleSample, scale = params$singleScale, prop = params$singleProp)
}
      
```

```{r show cd3 spectra text entry, echo = FALSE, results='asis'}
if(!is.null(params$singleSample) && !is.null(params$singleScale) && !is.null(params$singleProp)){
  cat(params$cd3spectraText)
}
```


```{r show Individual spectratyping title, results='asis', echo=FALSE}
if(!is.null(params$singleSample) && !is.null(params$singleScale) && !is.null(params$spectraProp)){cat("### Individual spectratyping")}
```

```{r cd3 spectra ind, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$singleSample) && !is.null(params$singleScale) && !is.null(params$spectraProp)){
   plotSpectratypingV(x = params$dataFiltered, sampleName = params$singleSample, scale = params$singleScale, prop = params$spectraProp)
}
      
```

```{r show cd3 spectra ind text entry, echo = FALSE, results='asis'}
if(!is.null(params$singleSample) && !is.null(params$singleScale) && !is.null(params$spectraProp)){
  cat(params$cd3spectraindText)
}
```


```{r show Multi-sample analysis title, results='asis', echo=FALSE}
if((!is.null(params$statisticsStat) && !is.null(params$statisticsGroup)) || 
   (!is.null(params$diverLevel) && !is.null(params$diverGroup) && !is.null(params$diverIndex)) || 
   (!is.null(params$multrenLevel) && !is.null(params$multrenGroup)) || 
   (!is.null(params$countIntervalsLevel) && !is.null(params$countIntervalsGroup)) || 
   (!is.null(params$multRankLevel) && !is.null(params$multRankScale) && !is.null(params$multRankGroup)) || 
   (!is.null(params$geneUsageLevel) && !is.null(params$geneUsageScale) && !is.null(params$geneUsageGroup)) || 
   (!is.null(params$vennLevel) && !is.null(params$vennSamples)) || 
   (!is.null(params$scatterUISample) && !is.null(params$scatterLevel) && !is.null(params$scatterScale)) || 
   (!is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityIndex) && !is.null(params$dissimilarityClustering) && params$doHm1 == 1) || 
   (!is.null(params$MDSLevel) && !is.null(params$MDSMethod) && !is.null(params$grpCol4MDS)) || 
   (!is.null(params$diffLevel) && !is.null(params$diffGroup) && !is.null(params$diffFC) && !is.null(params$diffPV)) || 
   (!is.null(params$diffPCALevel) && !is.null(params$PCAMethod) && !is.null(params$diffPCAGroup)) || 
   (!is.null(params$PertGroupSelected) && !is.null(params$CtrlGroup) && !is.null(params$pertDist) && !is.null(params$pertOrder) && params$doHm == 1)){cat("# Multi-sample analysis")}
```


```{r show Comparison of basic statistics title, results='asis', echo=FALSE}
if((!is.null(params$statisticsStat) && !is.null(params$statisticsGroup) && params$doStats == 1) || 
   (!is.null(params$diverLevel) && !is.null(params$diverGroup) && !is.null(params$diverIndex) && params$doDiversity == 1) || 
   (!is.null(params$multrenLevel) && !is.null(params$multrenGroup)) || 
   (!is.null(params$countIntervalsLevel) && !is.null(params$countIntervalsGroup) && params$doCountInt == 1) || 
   (!is.null(params$multRankLevel) && !is.null(params$multRankScale) && !is.null(params$multRankGroup)) || 
   (!is.null(params$geneUsageLevel) && !is.null(params$geneUsageScale) && !is.null(params$geneUsageGroup) && params$dogeneUsage == 1)){cat("## Comparison of basic statistics")}
```


```{r show Metadata statistics multiple title, results='asis', echo=FALSE}
if(!is.null(params$statisticsStat) && !is.null(params$statisticsGroup) && params$doStats == 1){cat("### Metadata statistics")}
```

```{r stats, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$statisticsStat) && !is.null(params$statisticsGroup) && params$doStats == 1){
    plotStatistics(x = params$dataFiltered, stat = params$statisticsStat, groupBy = params$statisticsGroup, label_colors = NULL)
}
      
```

```{r show stats text entry, echo = FALSE, results='asis'}
if(!is.null(params$statisticsStat) && !is.null(params$statisticsGroup) && params$doStats == 1){
  cat(params$statsText)
}
```


```{r show Diversity indices multiple title, results='asis', echo=FALSE}
if(!is.null(params$diverLevel) && !is.null(params$diverGroup) && !is.null(params$diverIndex) && params$doDiversity == 1){cat("### Diversity indices")}
```

```{r div, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$diverLevel) && !is.null(params$diverGroup) && !is.null(params$diverIndex) && params$doDiversity == 1){
    plotDiversity(x = params$dataFiltered, level = params$diverLevel, groupBy = params$diverGroup, index = params$diverIndex, label_colors = NULL)
}
     
```

```{r show div text entry, echo = FALSE, results='asis'}
if(!is.null(params$diverLevel) && !is.null(params$diverGroup) && !is.null(params$diverIndex) && params$doDiversity == 1){
  cat(params$divText)
}
```


```{r show Renyi index multiple title, results='asis', echo=FALSE}
if(!is.null(params$multrenLevel) && !is.null(params$multrenGroup)){cat("### Renyi index")}
```

```{r renyi, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$multrenLevel) && !is.null(params$multrenGroup)){
    plotRenyiIndex(x = params$dataFiltered, level = params$multrenLevel, colorBy = params$multrenGroup, grouped = TRUE, label_colors = NULL)
}
    
```

```{r show renyi text entry, echo = FALSE, results='asis'}
if(!is.null(params$multrenLevel) && !is.null(params$multrenGroup)){
  cat(params$renyiText)
}
```


```{r show Count intervals multiple title, results='asis', echo=FALSE}
if(!is.null(params$countIntervalsLevel) && !is.null(params$countIntervalsGroup) && params$doCountInt == 1){cat("### Count intervals")}
```

```{r countInt, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$countIntervalsLevel) && !is.null(params$countIntervalsGroup) && params$doCountInt == 1){
    plotCountIntervals(x = params$dataFiltered, level = params$countIntervalsLevel, groupBy = params$countIntervalsGroup, label_colors = NULL)
}
       
```

```{r show countInt text entry, echo = FALSE, results='asis'}
if(!is.null(params$countIntervalsLevel) && !is.null(params$countIntervalsGroup) && params$doCountInt == 1){
  cat(params$countIntText)
}
```


```{r show Rank distribution multiple title, results='asis', echo=FALSE}
if(!is.null(params$multRankLevel) && !is.null(params$multRankScale) && !is.null(params$multRankGroup)){cat("### Rank distribution")}
```

```{r rankDistrib, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$multRankLevel) && !is.null(params$multRankScale) && !is.null(params$multRankGroup)){
    plotRankDistrib(x = params$dataFiltered, level = params$multRankLevel, scale = params$multRankScale, colorBy = params$multRankGroup, grouped = TRUE, label_colors = NULL)
}
     
```

```{r show rankDistrib text entry, echo = FALSE, results='asis'}
if(!is.null(params$multRankLevel) && !is.null(params$multRankScale) && !is.null(params$multRankGroup)){
  cat(params$rankDistribText)
}
```


```{r show V/J usage multiple title, results='asis', echo=FALSE}
if(!is.null(params$geneUsageLevel) && !is.null(params$geneUsageScale) && !is.null(params$geneUsageGroup) && params$dogeneUsage == 1){cat("### V/J usage")}
```

```{r geneUsage, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$geneUsageLevel) && !is.null(params$geneUsageScale) && !is.null(params$geneUsageGroup) && params$dogeneUsage == 1){
    plotGeneUsage(x = params$dataFiltered, level = params$geneUsageLevel, scale = params$geneUsageScale, groupBy = params$geneUsageGroup, label_colors = NULL)
}
    
```

```{r show geneUsage text entry, echo = FALSE, results='asis'}
if(!is.null(params$geneUsageLevel) && !is.null(params$geneUsageScale) && !is.null(params$geneUsageGroup) && params$dogeneUsage == 1){
  cat(params$geneUsageText)
}
```
 
 

```{r show Similarity analysis title, results='asis', echo=FALSE}
if((!is.null(params$vennLevel) && !is.null(params$vennSamples)) || 
   (!is.null(params$scatterUISample) && !is.null(params$scatterLevel) && !is.null(params$scatterScale)) || 
   (!is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityIndex) && !is.null(params$dissimilarityClustering) && params$doHm1 == 1) || 
   (!is.null(params$MDSLevel) && !is.null(params$MDSMethod) && !is.null(params$grpCol4MDS))){cat("## Similarity analysis")}
```


```{r show Repertoire overlap title, results='asis', echo=FALSE}
if(!is.null(params$vennLevel) && !is.null(params$vennSamples)){cat("### Repertoire overlap")}
```

```{r eulerr, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$vennLevel) && !is.null(params$vennSamples)){
    plotEulerr(x = params$dataFiltered, level = params$vennLevel, sampleNames = params$vennSamples)
}
    
```

```{r show eulerr text entry, echo = FALSE, results='asis'}
if(!is.null(params$vennLevel) && !is.null(params$vennSamples)){
  cat(params$eulerrText)
}
```
 

```{r show Repertoire correlation title, results='asis', echo=FALSE}
if(!is.null(params$scatterUISample) && !is.null(params$scatterLevel) && !is.null(params$scatterScale)){cat("### Repertoire correlation")}
```

```{r scatter, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$scatterUISample) && !is.null(params$scatterLevel) && !is.null(params$scatterScale)){
    plotScatter(x = params$dataFiltered, sampleNames = params$scatterUISample, level = params$scatterLevel, scale = params$scatterScale)
}
    
```

```{r show scatter text entry, echo = FALSE, results='asis'}
if(!is.null(params$scatterUISample) && !is.null(params$scatterLevel) && !is.null(params$scatterScale)){
  cat(params$scatterText)
}
```


```{r show Hierarchical clustering title, results='asis', echo=FALSE}
if(!is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityIndex) && !is.null(params$dissimilarityClustering) && params$doHm1 == 1){cat("### Hierarchical clustering")}
```

```{r disHM, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityIndex) && !is.null(params$dissimilarityClustering) && params$doHm1 == 1){
    hm <- plotDissimilarityMatrix(x = params$dataFiltered, level = params$dissimilarityLevel, method = params$dissimilarityIndex, binary = FALSE, clustering = params$dissimilarityClustering, label_colors = NULL)
    ComplexHeatmap::draw(hm)
}
    
```

```{r show disHM text entry, echo = FALSE, results='asis'}
if(!is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityLevel) && !is.null(params$dissimilarityIndex) && !is.null(params$dissimilarityClustering) && params$doHm1 == 1){
  cat(params$disHMText)
}
```


```{r show Multidimensional scaling title, results='asis', echo=FALSE}
if(!is.null(params$MDSLevel) && !is.null(params$MDSMethod) && !is.null(params$grpCol4MDS)){cat("### Multidimensional scaling")}
```

```{r MDS, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$MDSLevel) && !is.null(params$MDSMethod) && !is.null(params$grpCol4MDS)){
    group <- switch((params$grpCol4MDS == "Sample") + 1, params$grpCol4MDS, NULL)
    plotDimReduction(x = params$dataFiltered, level = params$MDSLevel, method = params$MDSMethod, colorBy = group, label_colors = NULL, dim_method = "MDS")
}
    
```

```{r show MDS text entry, echo = FALSE, results='asis'}
if(!is.null(params$MDSLevel) && !is.null(params$MDSMethod) && !is.null(params$grpCol4MDS)){
  cat(params$MDSText)
}
```


```{r show Differential analysis title, results='asis', echo=FALSE}
if((!is.null(params$diffLevel) && !is.null(params$diffGroup) && !is.null(params$diffFC) && !is.null(params$diffPV)) || 
   (!is.null(params$diffPCALevel) && !is.null(params$PCAMethod) && !is.null(params$diffPCAGroup))){cat("## Differential analysis")}
```


```{r show Volcano plot title, results='asis', echo=FALSE}
if(!is.null(params$diffLevel) && !is.null(params$diffGroup) && !is.null(params$diffFC) && !is.null(params$diffPV)){cat("### Volcano plot")}
```

```{r volcano, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$diffLevel) && !is.null(params$diffGroup) && !is.null(params$diffFC) && !is.null(params$diffPV)){
    plotVolcano(x = params$dataFiltered, level = params$diffLevel, group =  params$diffGroup, FC.TH = params$diffFC, PV.TH = params$diffPV, top = 0)
}
    
```

```{r show volcano text entry, echo = FALSE, results='asis'}
if(!is.null(params$diffLevel) && !is.null(params$diffGroup) && !is.null(params$diffFC) && !is.null(params$diffPV)){
  cat(params$volcanoText)
}
```


```{r diffExpGroup, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(!is.null(params$diffGroup) && !is.null(params$diffLevel)){
    diffexp <- diffExpGroup(x = params$dataFiltered, colGrp = params$diffGroup[[1]], level = params$diffLevel, group = params$diffGroup)
   flextable::flextable(head(diffexp)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")  
}
    
```


```{r show Principal component analysis title, results='asis', echo=FALSE}
if(!is.null(params$diffPCALevel) && !is.null(params$PCAMethod) && !is.null(params$diffPCAGroup)){cat("### Principal component analysis")}
```

```{r PCA, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$diffPCALevel) && !is.null(params$PCAMethod) && !is.null(params$diffPCAGroup)){
    plotDimReduction(x = params$dataFiltered, level = params$diffPCALevel, method = params$PCAMethod, colorBy = params$diffPCAGroup, label_colors = NULL, dim_method = "PCA")
}
    
```

```{r show PCA text entry, echo = FALSE, results='asis'}
if(!is.null(params$diffPCALevel) && !is.null(params$PCAMethod) && !is.null(params$diffPCAGroup)){
  cat(params$PCAText)
}
```

```{r show Spectractyping comparison title, results='asis', echo=FALSE}
if(!is.null(params$PertGroupSelected) && !is.null(params$CtrlGroup) && !is.null(params$pertDist) && !is.null(params$pertOrder) && params$doHm == 1){cat("## Spectractyping comparison")}
```

```{r spectratyping comparison HM, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, results='hide',fig.keep='all', fig.width=12, fig.height=6}
if(!is.null(params$PertGroupSelected) && !is.null(params$CtrlGroup) && !is.null(params$pertDist) && !is.null(params$pertOrder) && params$doHm == 1){
    sampleinfo <- mData(params$dataFiltered)
    ctrnames <- rownames(sampleinfo)[which(sampleinfo[, params$PertGroupSelected] %in% params$CtrlGroup)]
    hm1 <- plotPerturbationScore(x = params$dataFiltered, ctrl.names = ctrnames, distance = params$pertDist, order = params$pertOrder, label_colors = NULL)
    ComplexHeatmap::draw(hm1)
}
    
```

```{r show spectratyping comparison HM text entry, echo = FALSE, results='asis'}
if(!is.null(params$PertGroupSelected) && !is.null(params$CtrlGroup) && !is.null(params$pertDist) && !is.null(params$pertOrder) && params$doHm == 1){
  cat(params$spectratypingcomparisonHMText)
}
```


```{r spectratypingcomparisontable, echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.width=17, fig.height=6, fig.align='center'}
if(!is.null(params$PertGroupSelected) && !is.null(params$CtrlGroup) && !is.null(params$pertDist) && !is.null(params$pertOrder) && params$doHm == 1){
    sampleinfo <- mData(params$dataFiltered)
    ctrnames <- rownames(sampleinfo)[which(sampleinfo[, params$PertGroupSelected] %in% params$CtrlGroup)]
    pertscore <- perturbationScore(x = params$dataFiltered, ctrl.names = ctrnames, distance = params$pertDist, p = 2)
    flextable::flextable(head(pertscore)) %>%
     flextable::theme_vanilla() %>%
     flextable::color(color="#022f5a", part="header")  
}
    
```

